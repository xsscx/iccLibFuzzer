# Dockerfile for libFuzzer on srdcx/iccdev base image
FROM srdcx/iccdev:latest

USER root

ENV DEBIAN_FRONTEND=noninteractive
ENV CC=clang-18
ENV CXX=clang++-18

# Install clang-18 and fuzzing dependencies (avoid broken llvm-21)
RUN mkdir -p /var/lib/apt/lists/partial && \
    chmod 755 /var/lib/apt/lists/partial && \
    apt-get clean && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
    clang-18 \
    llvm-18 \
    llvm-18-dev \
    libclang-rt-18-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /src/ipatch

# Copy source (assumes running from ipatch repo root)
COPY . /src/ipatch/

# Build fuzzers with Address Sanitizer
RUN mkdir -p /fuzzers/address && \
    cd /src/ipatch/Build/Cmake && \
    BUILD_DIR="build_asan_$(date +%s)" && \
    cmake -B "$BUILD_DIR" -S . \
      -DCMAKE_C_COMPILER=clang-18 \
      -DCMAKE_CXX_COMPILER=clang++-18 \
      -DCMAKE_C_FLAGS="-O1 -fno-omit-frame-pointer -gline-tables-only -fsanitize=address,fuzzer-no-link" \
      -DCMAKE_CXX_FLAGS="-O1 -fno-omit-frame-pointer -gline-tables-only -fsanitize=address,fuzzer-no-link" \
      -DCMAKE_BUILD_TYPE=RelWithDebInfo \
      -DBUILD_SHARED_LIBS=OFF && \
    cmake --build "$BUILD_DIR" --target IccProfLib2-static -j$(nproc) && \
    cd /src/ipatch && \
    for fuzzer in icc_link_fuzzer icc_dump_fuzzer icc_apply_fuzzer icc_roundtrip_fuzzer icc_profile_fuzzer icc_io_fuzzer; do \
      clang++-18 -O1 -fno-omit-frame-pointer -gline-tables-only \
        -fsanitize=address,fuzzer \
        -I/src/ipatch/IccProfLib \
        -I/src/ipatch/Tools/CmdLine/IccCommon \
        -I/src/ipatch/Tools/CmdLine/IccApplyProfiles \
        /src/ipatch/fuzzers/${fuzzer}.cpp \
        /src/ipatch/Build/Cmake/${BUILD_DIR}/IccProfLib/libIccProfLib2-static.a \
        -o /fuzzers/address/${fuzzer}; \
    done && \
    mkdir -p /fuzzers/address/corpus && \
    cp /src/ipatch/Testing/*.icc /fuzzers/address/corpus/ 2>/dev/null || true

# Build fuzzers with Undefined Behavior Sanitizer
RUN mkdir -p /fuzzers/undefined && \
    cd /src/ipatch/Build/Cmake && \
    BUILD_DIR="build_ubsan_$(date +%s)" && \
    cmake -B "$BUILD_DIR" -S . \
      -DCMAKE_C_COMPILER=clang-18 \
      -DCMAKE_CXX_COMPILER=clang++-18 \
      -DCMAKE_C_FLAGS="-O1 -fno-omit-frame-pointer -gline-tables-only -fsanitize=undefined,fuzzer-no-link" \
      -DCMAKE_CXX_FLAGS="-O1 -fno-omit-frame-pointer -gline-tables-only -fsanitize=undefined,fuzzer-no-link" \
      -DCMAKE_BUILD_TYPE=RelWithDebInfo \
      -DBUILD_SHARED_LIBS=OFF && \
    cmake --build "$BUILD_DIR" --target IccProfLib2-static -j$(nproc) && \
    cd /src/ipatch && \
    for fuzzer in icc_link_fuzzer icc_dump_fuzzer icc_apply_fuzzer icc_roundtrip_fuzzer icc_profile_fuzzer icc_io_fuzzer; do \
      clang++-18 -O1 -fno-omit-frame-pointer -gline-tables-only \
        -fsanitize=undefined,fuzzer \
        -I/src/ipatch/IccProfLib \
        -I/src/ipatch/Tools/CmdLine/IccCommon \
        -I/src/ipatch/Tools/CmdLine/IccApplyProfiles \
        /src/ipatch/fuzzers/${fuzzer}.cpp \
        /src/ipatch/Build/Cmake/${BUILD_DIR}/IccProfLib/libIccProfLib2-static.a \
        -o /fuzzers/undefined/${fuzzer}; \
    done && \
    cp -r /fuzzers/address/corpus /fuzzers/undefined/

# Create test runner script
RUN cat > /run-fuzzer.sh <<'EOF'
#!/bin/bash
set -e

SANITIZER=${SANITIZER:-address}
FUZZER=${FUZZER:-icc_profile_fuzzer}
DURATION=${DURATION:-60}
JOBS=${JOBS:-$(nproc)}

echo "========================================"
echo "Base Image: srdcx/iccdev:latest"
echo "Fuzzer: $FUZZER"
echo "Sanitizer: $SANITIZER"
echo "Duration: ${DURATION}s"
echo "Jobs: $JOBS"
echo "========================================"

mkdir -p /tmp/corpus

/fuzzers/${SANITIZER}/${FUZZER} \
  -jobs=$JOBS \
  -workers=$JOBS \
  -max_total_time=$DURATION \
  -rss_limit_mb=2048 \
  -timeout=25 \
  /tmp/corpus \
  /fuzzers/${SANITIZER}/corpus
EOF

RUN chmod +x /run-fuzzer.sh

WORKDIR /fuzzers

ENV SANITIZER=address
ENV FUZZER=icc_profile_fuzzer
ENV DURATION=60
ENV JOBS=1

CMD ["/bin/bash", "/run-fuzzer.sh"]
